<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hear the star</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* Global layout and basic reset */
        body { margin: 0; overflow: hidden; background-color: #000; }
        canvas { display: block; }

        /* Full screen system loader */
        #loader { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; justify-content: center; align-items: center; z-index: 1000; color: #0055ff; font-family: monospace; font-size: 16px; letter-spacing: 3px; pointer-events: none; transition: opacity 1s ease; }

        /* Entry overlay for project narrative */
        #intro-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 999; color: #e0f0ff; font-family: sans-serif; text-align: center; padding: 20px; opacity: 0; visibility: hidden; transition: opacity 2s ease; }
        #intro-overlay.visible { opacity: 1; visibility: visible; }
        .intro-text { max-width: 800px; line-height: 1.8; font-size: 1.1rem; margin-bottom: 40px; text-shadow: 0 0 10px rgba(0, 85, 255, 0.5); }

        /* Modular UI buttons */
        .ui-btn { padding: 15px 40px; background: transparent; border: 2px solid #ffffff; color: #ffffff; font-family: monospace; font-size: 1rem; font-weight: bold; cursor: pointer; transition: all 0.3s ease; letter-spacing: 2px; }
        .ui-btn:hover { background: #ffffff; color: #000; box-shadow: 0 0 20px #ffffff; }

        /* Main dialect information display */
        #dialect-display { position: absolute; top: 15%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 10; opacity: 0; transition: opacity 1s ease; pointer-events: none; width: 100%; }
        #dialect-name { color: #ffffff; font-size: 5.5rem; font-weight: bold; margin: 0; letter-spacing: 12px; text-shadow: 0 0 20px rgba(255, 255, 255, 0.5); }
        #dialect-pinyin { color: #ffffff; font-size: 2.2rem; font-weight: bold; font-family: monospace; margin: 10px 0; letter-spacing: 4px; }
        #dialect-link { color: #ffffff; text-decoration: underline; font-size: 1.2rem; pointer-events: auto; }

        /* Interaction containers */
        #switch-container { position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%); z-index: 100; opacity: 0; transition: opacity 1s ease; pointer-events: none; }
        #switch-container.active { opacity: 1; pointer-events: auto; }
        #audio-controls { position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 110; opacity: 0; visibility: hidden; transition: opacity 0.8s; pointer-events: none; width: 350px; }
        #audio-controls.active { opacity: 1; visibility: visible; pointer-events: auto; }
        .audio-label { color: #ffffff; font-size: 1.2rem; margin-bottom: 20px; letter-spacing: 5px; text-shadow: 0 0 10px #00aaff; }

        /* Real-time danmaku (floating comments) overlay */
        #danmaku-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2000; overflow: hidden; }
        .danmaku { position: absolute; white-space: nowrap; color: #ffffff; font-size: 1.6rem; font-weight: bold; text-shadow: 0 0 10px rgba(0, 170, 255, 1); will-change: transform; }
        .dialect-tag { color: #00d4ff; margin-right: 10px; font-size: 1rem; }

        /* Input area styling */
        #comment-input-area { margin-top: 30px; display: flex; gap: 10px; }
        #comment-input { flex-grow: 1; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 10px; outline: none; }
        #scroll-hint { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); color: rgba(255, 255, 255, 0.4); font-size: 0.8rem; letter-spacing: 2px; }
    </style>
</head>
<body>

<div id="loader">Welcome to see the star.</div>

<div id="danmaku-container"></div> 

<div id="intro-overlay">
    <div class="intro-text">
        Across the vast landscape of China, ancient dialects are fading into silence, much like stars winking out in the night sky. Every dying dialect is a unique celestial body and a distinct way of seeing the universe that is danger of being lost forever. <br><br>
        This project is a linguistic cosmos of those endangered voices. Enter our galaxy, connect with a disappearing dialect, and help keep its spark alive.
    </div>
    <button id="explore-btn" class="ui-btn">ENTER OUR GALAXY</button>
</div>

<div id="dialect-display">
    <h1 id="dialect-name">...</h1>
    <p id="dialect-pinyin"></p>
    <a id="dialect-link" href="#" target="_blank">LEARN MORE</a>
</div>

<div id="audio-controls">
    <div class="audio-label">Hear the sound of star</div>
    <button id="play-btn" class="ui-btn">PLAY AUDIO</button>
    <div id="comment-input-area">
        <input type="text" id="comment-input" placeholder="Share your wishes..." maxlength="30">
        <button id="send-btn" class="ui-btn">SEND</button>
    </div>
</div>

<div id="switch-container"><button id="switch-btn" class="ui-btn">FIND ANOTHER DIALECT</button></div>
<div id="scroll-hint">SCROLL UP TO FOCUS</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://unpkg.com/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
<script src="https://unpkg.com/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
<script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
<script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
<script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
<script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>

<script>
    // Global variable initialization
    const socket = io();
    let dialectData = []; // Storage for external JSON data
    let currentDialectName = "";
    let zoomLevel = 0, targetZoom = 0;
    const scrollSpeed = 0.002, focusThreshold = 0.8;
    const currentDialectAudio = new Audio();

    // Cache core DOM elements
    const swContainer = document.getElementById('switch-container');
    const audioCtrl = document.getElementById('audio-controls');
    const scrollHint = document.getElementById('scroll-hint');
    const danmakuBox = document.getElementById('danmaku-container');
    const intro = document.getElementById('intro-overlay');
    const display = document.getElementById('dialect-display');

    // Setup 3D Scene and Perspective Camera
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 1, 3000);
    const originalPos = new THREE.Vector3(0, 80, 160);
    camera.position.copy(originalPos);

    // Renderer setup with Bloom effect pipeline
    const renderer = new THREE.WebGLRenderer({ antialias: false });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);
    
    const composer = new THREE.EffectComposer(renderer);
    composer.addPass(new THREE.RenderPass(scene, camera));
    composer.addPass(new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.2, 0.5, 0.1));

    // Custom Shader for galaxy particles physics and visuals
    const diskMaterial = new THREE.ShaderMaterial({
        uniforms: { uTime: { value: 0 }, uZoom: { value: 0 } },
        vertexShader: `
            uniform float uTime; uniform float uZoom; 
            attribute float aSize; attribute vec3 aColor; 
            attribute float aAngle; attribute float aRadius; 
            attribute float aSpeed; attribute float aRandom; 
            varying vec3 vColor; 
            void main() { 
                vColor = aColor; 
                float cur = aAngle + uTime * aSpeed * (35.0 / aRadius); 
                vec3 pos; 
                pos.x = cos(cur) * aRadius; 
                pos.z = sin(cur) * aRadius; 
                pos.y = sin(uTime * 1.2 + aRadius * 0.4) * (aRandom * 1.8); 
                vec3 dir = normalize(pos); 
                pos += dir * (uZoom * (aRadius * 5.0 + aRandom * 50.0)); 
                vec4 mv = modelViewMatrix * vec4(pos, 1.0); 
                gl_Position = projectionMatrix * mv; 
                gl_PointSize = aSize * (350.0 / -mv.z); 
            }`,
        fragmentShader: `
            varying vec3 vColor; 
            void main(){ 
                float d = distance(gl_PointCoord, vec2(0.5)); 
                if(d>0.5) discard; 
                gl_FragColor = vec4(vColor, pow(1.0-(d*2.0), 2.2)); 
            }`,
        transparent: true, depthWrite: false, blending: THREE.AdditiveBlending
    });

    // Initialize geometry with point cloud attributes
    const diskGeo = new THREE.BufferGeometry();
    const d_pos=[], d_colors=[], d_sizes=[], d_angles=[], d_radii=[], d_speeds=[], d_randoms=[];
    for(let i=0; i<130000; i++){
        d_pos.push(0,0,0); 
        d_angles.push(Math.random()*Math.PI*2); 
        d_randoms.push(Math.random());
        let r=Math.random(), radius, size, speed, col=new THREE.Color();
        
        if(r<0.22){ 
            radius=15+Math.random()*8; speed=0.7+Math.random()*0.3; size=1.2+Math.random()*0.8; 
            col.lerpColors(new THREE.Color(0x33ffff), new THREE.Color(0x00aaaa), (radius-18)/2); 
        } else if(r<0.28){ 
            radius=23+Math.random()*5; speed=0.6; size=0.7; col.setHex(0x001122); 
        } else { 
            let dist=Math.pow(Math.random(),1.6); radius=28+dist*142; 
            speed=0.15+Math.random()*0.3; size=1.0+Math.random()*2.2; 
            col.lerpColors(new THREE.Color(0x0022dd), new THREE.Color(0x080044), (radius-65)/105); 
        }
        d_radii.push(radius); d_speeds.push(speed); d_sizes.push(size); d_colors.push(col.r, col.g, col.b);
    }
    
    diskGeo.setAttribute('position', new THREE.Float32BufferAttribute(d_pos, 3));
    diskGeo.setAttribute('aColor', new THREE.Float32BufferAttribute(d_colors, 3));
    diskGeo.setAttribute('aSize', new THREE.Float32BufferAttribute(d_sizes, 1));
    diskGeo.setAttribute('aAngle', new THREE.Float32BufferAttribute(d_angles, 1));
    diskGeo.setAttribute('aRadius', new THREE.Float32BufferAttribute(d_radii, 1));
    diskGeo.setAttribute('aSpeed', new THREE.Float32BufferAttribute(d_speeds, 1));
    diskGeo.setAttribute('aRandom', new THREE.Float32BufferAttribute(d_randoms, 1));
    
    scene.add(new THREE.Points(diskGeo, diskMaterial));
    scene.add(new THREE.Mesh(new THREE.SphereGeometry(14.5, 32, 32), new THREE.MeshBasicMaterial({color:0x000000})));

    // Animation variables
    const clock = new THREE.Clock();
    let mx=0, my=0;
    document.addEventListener('mousemove', (e)=>{ 
        mx=(e.clientX-window.innerWidth/2)*0.05; 
        my=(e.clientY-window.innerHeight/2)*0.05; 
    });
    window.addEventListener('wheel', (e) => { 
        targetZoom = Math.min(Math.max(targetZoom + e.deltaY * -scrollSpeed, 0), 1); 
    });

    // Update scene rendering loop
    function animate(){
        requestAnimationFrame(animate);
        zoomLevel += (targetZoom - zoomLevel) * 0.05;
        diskMaterial.uniforms.uZoom.value = zoomLevel;
        diskMaterial.uniforms.uTime.value = clock.getElapsedTime() * 0.2;
        
        camera.position.x = originalPos.x * (1 - zoomLevel) + mx;
        camera.position.y = (originalPos.y * (1 - zoomLevel) + 10) + my*0.5;
        camera.position.z = originalPos.z * (1 - zoomLevel) + 20;
        camera.lookAt(0,0,0);
        
        if(zoomLevel > focusThreshold) { 
            swContainer.classList.remove('active'); audioCtrl.classList.add('active'); scrollHint.style.opacity = 0; 
        } else {
            if(intro.style.display === 'none') swContainer.classList.add('active');
            audioCtrl.classList.remove('active'); scrollHint.style.opacity = 1;
        }
        composer.render();
    }

    // Function to pick random dialect from loaded array
    function updateDialect() {
        if (dialectData.length === 0) return;
        const item = dialectData[Math.floor(Math.random()*dialectData.length)];
        currentDialectName = item.dialect;
        document.getElementById('dialect-name').innerText = item.dialect;
        document.getElementById('dialect-pinyin').innerText = item.pinyin;
        document.getElementById('dialect-link').href = item.url;
        currentDialectAudio.pause(); 
        currentDialectAudio.src = `./${item.dialect}.m4a`; 
        currentDialectAudio.load();
    }

    // Generate scrolling community comments
    function createDanmaku(text, tag) {
        const el = document.createElement('div');
        el.className = 'danmaku';
        el.innerHTML = `<span class="dialect-tag">[${tag || '未知'}]</span>${text}`;
        const duration = 12 + Math.random() * 6;
        el.style.top = `${Math.random() * 70 + 15}%`;
        el.style.left = `100%`;
        el.style.transition = `transform ${duration}s linear`;
        danmakuBox.appendChild(el);
        setTimeout(() => el.style.transform = `translateX(-${window.innerWidth + el.offsetWidth + 800}px)`, 50);
        setTimeout(() => el.remove(), duration * 1000);
    }

    // Window load handler for data and UI initialization
    window.onload = () => {
        // Fetch full dataset from external JSON file
        fetch('Dialect.json')
            .then(res => res.json())
            .then(data => { 
                dialectData = data; 
                console.log(`System loaded ${dialectData.length} dialects.`); 
            })
            .catch(e => console.error("Data load failed:", e));

        setTimeout(() => { 
            document.getElementById('loader').style.opacity=0;
            setTimeout(() => { document.getElementById('loader').style.display='none'; intro.classList.add('visible'); }, 1000);
        }, 1500);

        // Entry exploration trigger
        document.getElementById('explore-btn').onclick = () => {
            updateDialect();
            intro.style.opacity = 0;
            setTimeout(() => { intro.style.display = 'none'; animate(); display.style.opacity = 1; swContainer.classList.add('active'); }, 2000);
        };

        // Dialect cycle trigger
        document.getElementById('switch-btn').onclick = () => {
            display.style.opacity = 0;
            setTimeout(() => { updateDialect(); display.style.opacity = 1; }, 800);
        };

        // Comment submission logic
        document.getElementById('send-btn').onclick = () => {
            const input = document.getElementById('comment-input');
            if(input.value.trim()){
                createDanmaku(input.value.trim(), currentDialectName);
                socket.emit('new_community_comment', { text: input.value.trim(), dialect: currentDialectName });
                input.value = "";
            }
        };

        // Network communication listeners
        socket.on('broadcast_comment', (data) => createDanmaku(data.text, data.dialect));
        document.getElementById('play-btn').onclick = () => currentDialectAudio.play().catch(e => console.log("Audio ready"));
    };
</script>
</body>
</html>